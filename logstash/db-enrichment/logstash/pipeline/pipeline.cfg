input {
  generator {
    lines => [
      '{"event": "login", "user_id": 1}',
      '{"event": "logout", "user_id": 2}',
      '{"event": "purchase", "user_id": 3}'
    ]
    count => 3
  }
}

filter {
  json {
    source => "message"
  }

  mutate {
    remove_field => ["message"]
  }

  jdbc_streaming {
    jdbc_connection_string => "${DB_JDBC_CONNECTION_STRING}"
    jdbc_user => "${DB_USER}"
    jdbc_password => "${DB_PASSWORD}"
    jdbc_driver_library => "/usr/share/logstash/postgresql-42.5.0.jar"
    jdbc_driver_class => "org.postgresql.Driver"
    statement => "
      SELECT user_name, user_email, user_group
      FROM db_users
      WHERE id = :input_parameter
    "
    parameters => {
      "input_parameter" => "user_id"
    }
    target => "sql"
  }

}

output {
  stdout { codec => rubydebug }
}
